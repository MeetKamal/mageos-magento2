name: "Coding Standard"
author: "Graycore"
description: "A Github Action that runs the Magento Coding Standard."

inputs:
  php_version:
    required: true
    default: "8.1"
    description: "PHP version used to do the coding standard check."

  composer_version:
    required: true
    default: "2"
    description: "The version of composer to use."

  path:
    required: true
    default: "app/code"
    description: "The directory (relative to the project root) in which the coding standard will be checked. Used when the event is not a pull request."

  version:
    required: false
    default: "31"
    description: "The version of the coding standard to use. If not provided, will use the latest version."

  severity:
    required: false
    default: "5"
    description: "The minimum severity required to display an error or warning (default: 5)"

  warning_severity:
    required: false
    default: "5"
    description: "The minimum severity required to display a warning"

  error_severity:
    required: false
    default: "5"
    description: "The minimum severity required to display an error"

runs:
  using: composite
  steps:
    - name: Checkout Project
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        path: standard

    - name: Set PHP Version
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ inputs.php_version }}
        tools: composer:v${{ inputs.composer_version }}
        coverage: none

    - name: Install Coding Standard && Codesniffer baseline
      shell: bash
      working-directory: standard
      run: |
        git config --global advice.detachedHead false
        composer require "magento/magento-coding-standard"
        composer config --no-plugins allow-plugins.digitalrevolution/php-codesniffer-baseline true
        composer require --dev "digitalrevolution/php-codesniffer-baseline"


    - name: Register Coding Standard
      shell: bash
      working-directory: standard
      run: vendor/bin/phpcs --config-set installed_paths ${{ github.workspace }}/standard/vendor/magento/magento-coding-standard,${{ github.workspace }}/standard/vendor/phpcompatibility/php-compatibility

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v35

    - name: Checkout - Before Merge
      shell: bash
      working-directory: standard
      id: previous-commit-files
      run: |
        if ${{ github.event_name == 'pull_request' }}; then
          git checkout ${{ github.event.pull_request.base.ref }}
        else
          git checkout ${{ github.event.before }}
        fi

        for file in ${{ steps.changed-files.outputs.all_modified_files }}; do
          echo $file >> ${{ github.workspace }}/file_lists_old.txt
        done
        cat ${{ github.workspace }}/file_lists_old.txt

    - name: Execute phpcs on changed files - Before Merge
      shell: bash
      id: phpcs_before
      working-directory: standard
      run: |
        grep -i "\.php$" ${{ github.workspace }}/file_lists_old.txt > ${{ github.workspace }}/file_php_old.txt
        echo $(php vendor/bin/phpcs --standard=Magento2 --report=\\DR\\CodeSnifferBaseline\\Reports\\Baseline --file-list=${{ github.workspace }}/file_php_old.txt) > ${{ github.workspace }}/phpcs_old.xml

    - name: Checkout - After Merge
      shell: bash
      working-directory: standard
      id: latest-files
      run: |
        if ${{ github.event_name == 'pull_request' }}; then
          git checkout ${{ github.event.pull_request.head.ref }}
        else
          git checkout ${{ github.event.after }}
        fi

        for file in ${{ steps.changed-files.outputs.all_modified_files }}; do
          echo $file >> ${{ github.workspace }}/file_lists_new.txt
        done

    - name: Execute phpcs on changed files - second time
      shell: bash
      id: phpcs_after
      working-directory: standard
      run: |
        grep -i "\.php$" ${{ github.workspace }}/file_lists_new.txt > ${{ github.workspace }}/file_php_new.txt
        php vendor/bin/phpcs --standard=Magento2 --report=\\DR\\CodeSnifferBaseline\\Reports\\Baseline --file-list=${{ github.workspace }}/file_php_new.txt
